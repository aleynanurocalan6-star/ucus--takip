<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <title>UÃ§uÅŸ Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* HaritanÄ±n Tam Ekran OlmasÄ±nÄ± SaÄŸlayÄ±n */
        #map { height: 100vh; width: 100vw; }
 
.hide-scrollbar::-webkit-scrollbar {
    display: none;
}
.hide-scrollbar {
    -ms-overflow-style: none; /* IE and Edge */
    scrollbar-width: none; /* Firefox */
}

/* 1.1 Genel Marker KapsayÄ±cÄ±sÄ± */
.leaflet-marker-icon {
    will-change: transform; 
    background-color: transparent !important; 
    border: none !important; 
     z-index: 600 !important;
}

/* 1.2 UÃ§ak Marker'Ä±na Ã–zel GeÃ§iÅŸ SÄ±nÄ±fÄ± (YumuÅŸak Ä°lerleme) */
.flight-marker-animated {
    transition: transform 4s cubic-bezier(0, 0, 0.25, 1) !important; 
}

/* 1.3 UÃ§ak Rotasyon KapsayÄ±cÄ±sÄ± (YÃ¶n DeÄŸiÅŸimi) */
.plane-rotator {
    transition: transform 0.5s ease-out; /* Rotasyonun yumuÅŸak olmasÄ± iÃ§in */
    transform-origin: center center; 
    background-color: transparent !important; 
}

/* 1.4 Terminal NoktalarÄ± KapsayÄ±cÄ±sÄ± */
.custom-dot-marker {
    background-color: transparent !important;
    border: none !important;
}

/* UÃ§ak Simgesi Stili (Font Awesome) */
.plane-icon {
    text-align: center;
    font-size: 24px; 
    line-height: 24px;
    transform-origin: center center;
    
    /* ğŸš€ KRÄ°TÄ°K DÃœZELTME: Ä°konun Kuzeye bakmasÄ± iÃ§in varsayÄ±lanÄ± dÃ¶ndÃ¼r */
    transform: rotate(90deg); 
    
    /* SarÄ± Parlak Efekt */
    color: #fcd34d; /* yellow-400 */
    text-shadow: 0 0 15px rgba(252, 211, 77, 1), 0 0 8px rgba(255, 255, 255, 0.7); 
    animation: pulse-glow 2s infinite alternate ease-in-out; 
    cursor: pointer;
}

/* UÃ§ak Simgesi Parlama Animasyonu */
@keyframes pulse-glow {
    from {
        opacity: 0.9;
        transform: scale(1) rotate(90deg); /* Animasyonda da 90 derece rotasyonu koru */
    }
    to {
        opacity: 1;
        transform: scale(1.2) rotate(90deg); /* Animasyonda da 90 derece rotasyonu koru */
    }
}

/* KalkÄ±ÅŸ/VarÄ±ÅŸ NoktasÄ± DotlarÄ± */
.dot-icon {
    width: 10px !important;
    height: 10px !important;
    border-radius: 50%;
    opacity: 0.8;
    margin-left: -5px !important; 
    margin-top: -5px !important; 
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.5); 
}
.dot-green { background-color: #10b981; }
.dot-red { background-color: #ef4444; }


/* ========================================================== */
/* BÃ–LÃœM 2: Uygulama ArayÃ¼z Stilleri (Glass Panel, Form, vb.) */
/* ========================================================== */

.glass-panel {
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
}

.custom-label {
    display: block;
    margin-bottom: 4px;
    font-size: 0.75rem; 
    font-weight: bold;
    color: #ccc;
    letter-spacing: 0.05em; 
}

.custom-input {
    width: 100%;
    padding: 8px 12px;
    border-radius: 6px;
    background-color: #1f2937; 
    border: 1px solid #4b5563; 
    color: #f3f4f6; 
    transition: border-color 0.2s;
}
.custom-input:focus {
    border-color: #fcd34d; 
    outline: none;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px dashed #374151; 
}
.detail-label {
    font-size: 0.875rem; 
    font-weight: 500;
    color: #9ca3af; 
}
.detail-value {
    font-size: 1rem; 
    font-weight: bold;
    color: #e5e7eb; 
}

.custom-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: #FCD34D; 
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
}
.custom-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #FCD34D;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
}
.list-progress-bar-container {
    width: 100%;
    background-color: #374151; 
    border-radius: 9999px;
    height: 6px;
    overflow: hidden;
    margin-top: 5px;
}
.list-progress-bar {
    height: 100%;
    transition: width 0.5s ease-out;
}
.mode-btn {
    padding: 8px 16px;
    border-radius: 9999px;
    font-weight: bold;
    transition: all 0.3s ease;
    cursor: pointer;
}
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">
    
    <div id="map"></div>
    
    <div id="message-box" class="fixed top-5 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-xl text-white z-[600] hidden transition-opacity duration-500 opacity-0" role="alert"></div>

    <div id="left-panel" class="glass-panel absolute top-5 left-0 w-72 max-h-[90vh] rounded-xl z-[500] flex flex-col transition-all duration-300 transform translate-x-[-100%]">
        <div class="p-4 border-b border-yellow-800/50 flex justify-between items-center bg-black/40 rounded-t-xl">
            <span class="text-yellow-400 font-extrabold tracking-widest text-xl">UÃ‡UÅ LÄ°STESÄ°</span>
            <button class="text-gray-400 hover:text-white transition text-xl" onclick="toggleLeftPanel(false)">âœ•</button>
        </div>

        <div id="flight-list" class="p-2 overflow-y-auto flex-grow" style="max-height: calc(90vh - 70px);"> 
            <div class="p-4 text-center text-gray-400">Veriler bekleniyor...</div>
        </div>
    </div>

    <button id="open-left-panel-btn" class="glass-panel absolute top-5 left-5 w-12 h-12 rounded-xl z-[400] text-yellow-400 text-2xl hover:bg-yellow-950 transition flex items-center justify-center" onclick="toggleLeftPanel(true)">
        â˜°
    </button>
    
    <button id="create-route-btn-top" class="absolute top-8 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black font-extrabold px-6 py-2 rounded-full shadow-[0_0_20px_rgba(255,215,0,0.6)] z-[500] hover:scale-105 transition duration-300" onclick="toggleRightPanel('form')">
        âœ¨ YENÄ° ROTA PLANLA
    </button>


    <div id="right-panel-form" class="glass-panel absolute top-5 right-5 bottom-5 w-96 rounded-xl z-[500] p-6 transform translate-x-[150%] transition-transform duration-300 overflow-y-auto hide-scrollbar">
        
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 class="text-3xl text-yellow-400 font-extrabold">ROTA PLANLAMA</h2>
                <p class="text-gray-400 text-sm mt-1">UÃ§uÅŸ bilgilerini girerek haritaya yeni bir rota ekle.</p>
            </div>
            <button class="text-yellow-400 text-xl hover:text-white transition close-btn" onclick="toggleRightPanel(null)">âœ•</button>
        </div>

        <form id="flight-form" class="space-y-6"> 
            
            <div>
                <label class="custom-label" for="flightId">UÃ‡UÅ KODU (ID)</label>
                <input type="text" id="flightId" required value="TK-101" class="custom-input">
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="custom-label" for="startCity">KALKIÅ ÅEHRÄ°</label>
                    <input type="text" id="startCity" required value="Ankara" class="custom-input">
                </div>
                <div>
                    <label class="custom-label" for="endCity">VARIÅ ÅEHRÄ°</label>
                    <input type="text" id="endCity" required value="Ä°stanbul" class="custom-input">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="custom-label" for="startDate">KALKIÅ ZAMANI (TARÄ°H)</label>
                    <input type="date" id="startDate" required value="2025-12-04" class="custom-input">
                </div>
                <div>
                    <label class="custom-label" for="startTime">KALKIÅ SAATÄ°</label>
                    <input type="time" id="startTime" required value="16:00" class="custom-input">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="custom-label" for="endDate">VARIÅ ZAMANI (TARÄ°H)</label>
                    <input type="date" id="endDate" required value="2025-12-04" class="custom-input">
                </div>
                <div>
                    <label class="custom-label" for="endTime">VARIÅ SAATÄ°</label>
                    <input type="time" id="endTime" required value="18:00" class="custom-input">
                </div>
            </div>

            <div>
                <label class="custom-label" for="startCoords">KALKIÅ KOORDÄ°NATLARI (Lat, Lng)</label>
                <input type="text" id="startCoords" required value="39.9208, 32.8541" class="custom-input">
            </div>

            <div>
                <label class="custom-label" for="endCoords">VARIÅ KOORDÄ°NATLARI (Lat, Lng)</label>
                <input type="text" id="endCoords" required value="41.0082, 28.9784" class="custom-input">
            </div>
            
            <button type="submit" id="submit-btn" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-extrabold py-3 rounded mt-6 transition shadow-[0_0_20px_rgba(255,215,0,0.7)]">
                KAYDET VE BAÅLAT
            </button>
        </form>
    </div>

    <div id="right-panel-detail" class="glass-panel absolute top-5 right-5 w-80 rounded-xl z-[500] transform translate-x-[150%] transition-transform duration-300">
        <div class="p-4 border-b border-yellow-800/50 flex justify-between items-center bg-black/40 rounded-t-xl">
            <div>
                <h2 id="detail-id" class="text-4xl text-yellow-300 font-extrabold tracking-widest">TK-800</h2>
                <span id="detail-status" class="text-sm uppercase font-bold tracking-widest mt-1 text-green-400">AKTÄ°F UÃ‡UÅ</span>
            </div>
            <button class="text-gray-400 hover:text-white transition text-xl" onclick="toggleRightPanel(null)">âœ•</button>
        </div>

        <div class="p-5 space-y-2">
            
            <div class="detail-row">
                <span class="detail-label">Rota:</span>
                <span id="detail-route" class="detail-value text-yellow-100">Bilinmiyor > Bilinmiyor</span> 
            </div>

            <div class="detail-row">
                <span class="detail-label">Konum:</span>
                <span id="detail-coords" class="detail-value font-mono text-base">Lat: 51.1700, Lng: -48.9343</span> 
            </div>

            <div class="detail-row">
                <span class="detail-label">HÄ±z (GS):</span>
                <span class="detail-value">850 km/sa</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">YÃ¼kseklik:</span>
                <span class="detail-value">35.000 ft</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Rotadan Sapma:</span>
                <span class="detail-value">0.00 km</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">KalkÄ±ÅŸ:</span>
                <span id="detail-dep-time" class="detail-value text-sm">05.01.2024 13:00:00</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Tahmini VarÄ±ÅŸ:</span>
                <span id="detail-arr-time" class="detail-value text-sm">N/A</span>
            </div>

            <div class="mt-6">
                <label class="custom-label text-yellow-500 mb-2">Ä°rtifa Verileri (SimÃ¼le)</label>
                <div class="w-full h-16 bg-gradient-to-t from-gray-800 to-transparent rounded border border-gray-700 relative overflow-hidden">
                    <svg class="absolute bottom-0 left-0 w-full h-full" preserveAspectRatio="none" viewBox="0 0 100 100">
                            <path d="M0,80 C20,70 50,40 100,50 L100,100 L0,100 Z" fill="rgba(16, 185, 129, 0.1)" stroke="#10b981" stroke-width="2"/>
                    </svg>
                    <div class="absolute bottom-1 left-2 text-[10px] text-gray-500">KalkÄ±ÅŸ</div>
                    <div class="absolute bottom-1 right-2 text-[10px] text-gray-500">VarÄ±ÅŸ</div>
                </div>
            </div>

            <button id="delete-btn" class="w-full mt-6 bg-red-700 hover:bg-red-600 text-white font-extrabold py-3 rounded text-base transition border border-red-500 shadow-[0_0_15px_rgba(255,0,0,0.5)]">
                UÃ‡UÅU SÄ°L (KayÄ±tlardan KaldÄ±r)
            </button>
        </div>
    </div>
    
    <button id="toggle-time-travel-btn" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black font-extrabold px-6 py-2 rounded-full shadow-[0_0_20px_rgba(255,215,0,0.6)] z-[500] hover:scale-105 transition duration-300">
        ğŸ•“ CANLI / ZAMAN YOLCULUÄU
    </button>

    <div id="time-travel-panel" class="glass-panel absolute bottom-[80px] left-1/2 transform -translate-x-1/2 w-[90%] md:w-[600px] rounded-xl z-[500] p-4 hidden">
        
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-extrabold text-yellow-400">ZAMAN KONTROL PANELÄ°</h3>
            <button class="text-gray-400 hover:text-white transition text-xl" id="close-time-travel-panel-btn">âœ•</button> 
        </div>

        <div class="flex justify-center space-x-4 mb-4">
            <button id="mode-live-btn" class="mode-btn bg-green-600 hover:bg-green-500 text-white shadow-lg" onclick="setMode('live')">
                ğŸŸ¢ CANLI AKIÅ (Åimdi)
            </button>
            <button id="mode-time-travel-btn" class="mode-btn bg-gray-700 hover:bg-gray-600 text-white shadow-lg" onclick="setMode('timetravel')">
                â³ GERÄ° OYNAT
            </button>
        </div>

        <div class="text-center mb-4 p-2 rounded bg-black/30">
            <span id="current-mode-display" class="font-bold text-lg text-green-400">CANLI AKIÅ MODU</span>
        </div>

        <div id="live-controls" class="space-y-3">
             <label class="custom-label text-yellow-500">CANLI AKIÅ HIZI KONTROLÃœ</label>
             <input type="range" id="live-speed-slider" min="1000" max="10000" value="5000" step="1000" 
                    class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer custom-slider">
             <div class="flex justify-between text-xs text-gray-400">
                 <span>Ã‡ok HÄ±zlÄ± (1 sn)</span>
                 <span id="slider-speed-display" class="font-bold text-yellow-400">5 saniyede bir</span>
                 <span>YavaÅŸ (10 sn)</span>
             </div>
        </div>

        <div id="timetravel-controls" class="space-y-4 hidden mt-6 pt-4 border-t border-gray-700">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="custom-label" for="tt-date">TARÄ°H SEÃ‡Ä°N</label>
                    <input type="date" id="tt-date" class="custom-input">
                </div>
                <div>
                    <label class="custom-label" for="tt-time">SAAT SEÃ‡Ä°N</label>
                    <input type="time" id="tt-time" class="custom-input">
                </div>
            </div>
            
            <div class="space-y-3">
                <label class="custom-label text-blue-400">TARÄ°HÄ° KAYDIRARAK SEÃ‡Ä°N</label>
                <input type="range" id="tt-time-slider" min="0" max="100" value="50" step="1" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer custom-slider">
                <div class="flex justify-between text-xs text-gray-400">
                   <span id="tt-slider-start">Ä°lk KayÄ±t</span>
                   <span id="tt-slider-display" class="font-bold text-blue-400">SeÃ§ili Zaman: N/A</span>
                   <span id="tt-slider-end">Åimdi</span>
                </div>
            </div>

            
            <button id="tt-apply-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-extrabold py-3 rounded transition shadow-[0_0_20px_rgba(0,191,255,0.7)]" onclick="applyTimeTravel()">
                UYGULA VE KONUMU GÃ–STER
            </button>

            <p class="text-yellow-400 text-sm italic text-center pt-2">SeÃ§ilen tarihteki anlÄ±k konumlar haritada gÃ¶sterilecektir.</p>
        </div>

   </div>

    <script>
   

    // ====================================================================
// A. SABÄ°TLER VE GLOBAL DEÄÄ°ÅKENLER
// ====================================================================

// API UÃ§ NoktalarÄ±
const API_BASE_URL = 'http://localhost:5058/api/flights';
const CURRENT_FLIGHT_URL = `${API_BASE_URL}/current`; 
const PLANNED_FLIGHTS_URL = `${API_BASE_URL}/planned`; 
const LIVE_POSITIONS_URL = `${API_BASE_URL}/livepositions`; 
const CREATE_FLIGHT_URL = `${API_BASE_URL}/create`;

// ====================================================================
// G. BAÅLANGIÃ‡ Ä°ÅLEMLERÄ° VE EVENT LISTENERS
// ====================================================================

// --- TEMEL DURUM YÃ–NETÄ°MÄ° ---
let map;
let allFlights = {}; // TÃ¼m uÃ§uÅŸ verilerini (aktif, tamamlanmÄ±ÅŸ, iptal) tutar
let activeFlights = {}; // Haritada gÃ¶sterilen marker'larÄ± tutar
let mapInitialized = false;
let currentMode = 'live'; // 'live' veya 'timetravel'
let liveInterval;
let DOM = {}; // DOM elementlerini tutacak nesne

// SimÃ¼lasyon baÅŸlangÄ±Ã§ zamanÄ± (Ã–rnek verinin baÅŸladÄ±ÄŸÄ± zaman)
const SIMULATION_START_TIME = new Date('2025-12-04T16:00:00').getTime();
const SIMULATION_END_TIME = new Date('2025-12-04T18:00:00').getTime();
let currentTime = Date.now(); // CanlÄ± modda anlÄ±k zamanÄ± tutar.
let timeTravelDate = new Date(); // Zaman yolculuÄŸu modunda seÃ§ilen zamanÄ± tutar.

// --- YARDIMCI FONKSÄ°YONLAR ---

function parseCoords(coordsStr) {
    const parts = coordsStr.split(',').map(s => s.trim());
    return { lat: parseFloat(parts[0]), lng: parseFloat(parts[1]) };
}

function showMessage(message, type = 'info') {
    const box = DOM.messageBox;
    box.textContent = message;
    
    // Eski sÄ±nÄ±flarÄ± kaldÄ±r
    box.classList.remove('bg-green-600', 'bg-red-600', 'bg-yellow-600', 'hidden', 'opacity-0');

    // Yeni sÄ±nÄ±flarÄ± ekle
    if (type === 'success') {
        box.classList.add('bg-green-600');
    } else if (type === 'error') {
        box.classList.add('bg-red-600');
    } else {
        box.classList.add('bg-yellow-600');
    }

    // GÃ¶ster
    box.classList.remove('hidden');
    // Animasyon iÃ§in kÄ±sa bir gecikme
    setTimeout(() => {
        box.classList.add('opacity-100');
    }, 10); 

    // Otomatik gizle
    setTimeout(() => {
        box.classList.remove('opacity-100');
        setTimeout(() => {
            box.classList.add('hidden');
        }, 500); 
    }, 4000);
}


// --- PANEL YÃ–NETÄ°MÄ° ---

function toggleLeftPanel(show) {
    const isVisible = DOM.leftPanel.classList.contains('translate-x-0');
    show = show === undefined ? !isVisible : show;

    if (show) {
        DOM.leftPanel.classList.remove('translate-x-[-100%]');
        DOM.leftPanel.classList.add('translate-x-0');
        DOM.openLeftPanelBtn.classList.add('hidden');
    } else {
        DOM.leftPanel.classList.remove('translate-x-0');
        DOM.leftPanel.classList.add('translate-x-[-100%]');
        DOM.openLeftPanelBtn.classList.remove('hidden');
    }
}

function toggleRightPanel(panelName) {
    // TÃ¼m panelleri gizle
    DOM.rightPanelForm.classList.add('translate-x-[150%]');
    DOM.rightPanelDetail.classList.add('translate-x-[150%]');

    if (panelName === 'form') {
        DOM.rightPanelForm.classList.remove('translate-x-[150%]');
    } else if (panelName === 'detail') {
        DOM.rightPanelDetail.classList.remove('translate-x-[150%]');
    } else if (panelName === null) {
        // TÃ¼m paneller gizlendi, iÅŸlem tamam.
    }
}

/** * UYARI: Bu fonksiyon HTML'de onClick ile Ã§aÄŸrÄ±lmamalÄ±dÄ±r!
 * Sadece 'toggle-time-travel-btn' ve 'close-time-travel-panel-btn' 
 * butonlarÄ±nÄ±n event listener'larÄ± tarafÄ±ndan Ã§aÄŸrÄ±lmalÄ±dÄ±r.
 */
function toggleTimeTravelPanel(show) {
    const isVisible = !DOM.timeTravelPanel.classList.contains('hidden');
    show = show === undefined ? !isVisible : show;

    if (show) {
        DOM.timeTravelPanel.classList.remove('hidden');
        DOM.toggleTimeTravelBtn.classList.add('hidden');
    } else {
        DOM.timeTravelPanel.classList.add('hidden');
        DOM.toggleTimeTravelBtn.classList.remove('hidden');
    }
}

// --- ZAMAN VE MOD YÃ–NETÄ°MÄ° ---

function setMode(mode) {
    if (currentMode === mode) return;

    currentMode = mode;

    DOM.modeLiveBtn.classList.remove('bg-yellow-500', 'bg-green-600');
    DOM.modeTimeTravelBtn.classList.remove('bg-yellow-500', 'bg-gray-700');
    DOM.liveControls.classList.add('hidden');
    DOM.timetravelControls.classList.add('hidden');

    clearInterval(liveInterval);

    if (mode === 'live') {
        DOM.modeLiveBtn.classList.add('bg-green-600');
        DOM.modeTimeTravelBtn.classList.add('bg-gray-700');
        DOM.currentModeDisplay.textContent = 'ğŸŸ¢ CANLI AKIÅ MODU';
        DOM.currentModeDisplay.classList.remove('text-blue-400');
        DOM.currentModeDisplay.classList.add('text-green-400');
        DOM.liveControls.classList.remove('hidden');
        
        // CanlÄ± moda geÃ§tiÄŸimizde, saati anlÄ±k zamana ayarla
        currentTime = Date.now(); 
        
        // Yeni canlÄ± aralÄ±ÄŸÄ±nÄ± baÅŸlat
        updateLiveInterval(DOM.liveSpeedSlider.value); 
        
        // Haritadaki uÃ§uÅŸlarÄ± canlÄ± zamana gÃ¶re gÃ¼ncelle
        updateFlightPositions(currentTime);

    } else if (mode === 'timetravel') {
        DOM.modeLiveBtn.classList.add('bg-gray-700');
        DOM.modeTimeTravelBtn.classList.add('bg-yellow-500');
        DOM.currentModeDisplay.textContent = 'â³ ZAMAN YOLCULUÄU MODU';
        DOM.currentModeDisplay.classList.remove('text-green-400');
        DOM.currentModeDisplay.classList.add('text-blue-400');
        DOM.timetravelControls.classList.remove('hidden');
        
        // Zaman yolculuÄŸu aralÄ±ÄŸÄ±nÄ± belirle
        DOM.ttSliderStart.textContent = formatDateTime(SIMULATION_START_TIME, true);
        DOM.ttSliderEnd.textContent = formatDateTime(Date.now(), true); // Veya en son kayÄ±t zamanÄ±

        // Zaman kaydÄ±rÄ±cÄ±sÄ±nÄ± baÅŸlat
        initializeTimeTravelSlider();
        
        // SeÃ§ili zamanÄ± gÃ¶ster
        applyTimeTravel();
    }
}

function updateLiveInterval(milliseconds) {
    clearInterval(liveInterval);
    const seconds = milliseconds / 1000;
    DOM.sliderSpeedDisplay.textContent = `${seconds} saniyede bir`;
    
    // ZamanÄ± kaydÄ±r
    liveInterval = setInterval(() => {
        currentTime += milliseconds; // ZamanÄ± arttÄ±r
        updateFlightPositions(currentTime);
        // Ä°htiyaÃ§ duyulursa burada bir 'canlÄ± zaman' gÃ¶sterimi gÃ¼ncellenebilir.
    }, milliseconds);
}

function initializeTimeTravelSlider() {
    // KayÄ±t aralÄ±ÄŸÄ±nÄ± bul (Ã–rnekte simÃ¼lasyon aralÄ±ÄŸÄ±nÄ± kullanÄ±yoruz)
    const minTime = SIMULATION_START_TIME;
    const maxTime = Date.now(); // Åu anki zaman
    
    // Slider min/max deÄŸerleri 0 ve 100 olduÄŸu iÃ§in, bu zaman aralÄ±ÄŸÄ±nÄ± kaydÄ±rmaya eÅŸitleyeceÄŸiz.
    
    // VarsayÄ±lan olarak anlÄ±k zamana ayarla
    timeTravelDate = new Date(maxTime);
    DOM.ttDateInput.value = formatDateForInput(timeTravelDate);
    DOM.ttTimeInput.value = formatTimeForInput(timeTravelDate);
    
    // Slider'Ä± en sona (100) ayarla
    DOM.ttTimeSlider.value = 100;
    updateTimeTravelDisplay(100);
}

function updateTimeTravelDisplay(sliderValue) {
    const minTime = SIMULATION_START_TIME;
    const maxTime = Date.now();
    
    // Slider deÄŸerini zamana dÃ¶nÃ¼ÅŸtÃ¼r (0-100 aralÄ±ÄŸÄ±)
    const targetTime = minTime + (maxTime - minTime) * (sliderValue / 100);
    timeTravelDate = new Date(targetTime);

    // Tarih/Saat kutularÄ±nÄ± gÃ¼ncelle
    DOM.ttDateInput.value = formatDateForInput(timeTravelDate);
    DOM.ttTimeInput.value = formatTimeForInput(timeTravelDate);

    // GÃ¶rÃ¼ntÃ¼leme etiketini gÃ¼ncelle
    DOM.ttSliderDisplay.textContent = `SeÃ§ili Zaman: ${formatDateTime(targetTime)}`;
}


function applyTimeTravel(sliderValue) {
    // Slider'dan Ã§aÄŸrÄ±lÄ±rsa slider deÄŸerini kullan, yoksa manuel giriÅŸleri kullan.
    if (sliderValue !== undefined) {
        const minTime = SIMULATION_START_TIME;
        const maxTime = Date.now();
        const targetTime = minTime + (maxTime - minTime) * (sliderValue / 100);
        timeTravelDate = new Date(targetTime);
    } else {
        // Manuel giriÅŸlerden zamanÄ± al
        const dateStr = DOM.ttDateInput.value;
        const timeStr = DOM.ttTimeInput.value;
        if (dateStr && timeStr) {
            timeTravelDate = new Date(`${dateStr}T${timeStr}:00`);
        }
        // Manuel giriÅŸten sonra slider'Ä± da eÅŸitlemek karmaÅŸÄ±k olduÄŸu iÃ§in, sadece zamanÄ± gÃ¶steriyoruz.
    }
    
    // Haritadaki uÃ§uÅŸlarÄ± seÃ§ilen zamana gÃ¶re gÃ¼ncelle
    updateFlightPositions(timeTravelDate.getTime());
}

// --- UÃ‡UÅ HESAPLAMA VE GÃœNCELLEME ---

/**
 * Bu fonksiyon, uÃ§uÅŸ rotasÄ± Ã¼zerindeki belirli bir andaki (targetTime) 
 * uÃ§ak konumunu interpolasyon yaparak hesaplar.
 * @param {object} flight - UÃ§uÅŸ verileri (startCoords, endCoords, startTime, endTime)
 * @param {number} targetTime - Hedef zamanÄ±n milisaniye deÄŸeri.
 * @returns {{lat: number, lng: number, heading: number, progress: number} | null} Konum, baÅŸ ve ilerleme yÃ¼zdesi veya null.
 */
function calculatePositionAtTime(flight, targetTime) {
    const startTime = flight.parsedStartTime;
    const endTime = flight.parsedEndTime;
    const duration = endTime - startTime;

    if (targetTime < startTime || targetTime > endTime) {
        // UÃ§uÅŸ henÃ¼z baÅŸlamadÄ± veya bitti.
        const position = targetTime < startTime ? flight.startCoords : flight.endCoords;
        const heading = calculateHeading(flight.startCoords, flight.endCoords);
        const progress = targetTime < startTime ? 0 : 1;
        return { lat: position.lat, lng: position.lng, heading, progress };
    }

    const elapsed = targetTime - startTime;
    const progress = elapsed / duration;

    const startLat = flight.startCoords.lat;
    const startLng = flight.startCoords.lng;
    const endLat = flight.endCoords.lat;
    const endLng = flight.endCoords.lng;

    // Basit lineer interpolasyon
    const lat = startLat + (endLat - startLat) * progress;
    const lng = startLng + (endLng - startLng) * progress;
    
    const heading = calculateHeading(flight.startCoords, flight.endCoords);

    return { lat, lng, heading, progress };
}

/**
 * Ä°ki koordinat arasÄ±ndaki aÃ§Ä±yÄ± (heading) hesaplar.
 */
function calculateHeading(start, end) {
    const lat1 = toRad(start.lat);
    const lon1 = toRad(start.lng);
    const lat2 = toRad(end.lat);
    const lon2 = toRad(end.lng);

    const dLon = lon2 - lon1;

    const y = Math.sin(dLon) * Math.cos(lat2);
    const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

    let brng = toDeg(Math.atan2(y, x));

    // AÃ§Ä± 0-360 aralÄ±ÄŸÄ±na getirilir (Kuzey 0 derece)
    return (brng + 360) % 360; 
}

function toRad(degrees) {
    return degrees * Math.PI / 180;
}

function toDeg(radians) {
    return radians * 180 / Math.PI;
}


/**
 * Haritadaki uÃ§uÅŸ marker'larÄ±nÄ±n konumunu gÃ¼nceller.
 * @param {number} targetTime - KonumlarÄ±n hesaplanacaÄŸÄ± hedef zaman.
 */
function updateFlightPositions(targetTime) {
    const flightIds = Object.keys(allFlights);
    
    // Her uÃ§uÅŸu kontrol et
    for (const id of flightIds) {
        const flight = allFlights[id];
        const { lat, lng, heading, progress } = calculatePositionAtTime(flight, targetTime);
        
        const isCurrentlyFlying = (progress > 0 && progress < 1);
        
        // Marker'Ä± gÃ¼ncelle veya kaldÄ±r
        if (isCurrentlyFlying) {
            if (!activeFlights[id]) {
                // UÃ§uÅŸ baÅŸladÄ±ysa haritaya ekle
                addFlightToMap(flight, lat, lng, heading);
            } else {
                // UÃ§uÅŸ devam ediyorsa konumunu gÃ¼ncelle
                updateFlightMarkerPosition(id, lat, lng, heading);
            }
        } else {
            if (activeFlights[id]) {
                // UÃ§uÅŸ bittiyse veya baÅŸlamadÄ±ysa haritadan kaldÄ±r
                removeFlightFromMap(id);
            }
        }
        
        // Sol paneldeki listeyi gÃ¼ncelle (ilerleme Ã§ubuÄŸu vb.)
        updateFlightListProgress(id, progress);
    }
    
    // Harita Ã¼zerindeki gÃ¼ncel uÃ§uÅŸ sayÄ±sÄ±nÄ± gÃ¶ster
    const activeCount = Object.keys(activeFlights).length;
    DOM.flightList.querySelector('div').textContent = activeCount > 0 ? '' : 'Haritada aktif uÃ§uÅŸ bulunmamaktadÄ±r.';
}


// --- MARKER YÃ–NETÄ°MÄ° (Leaflet) ---

// Kendi Ã¶zel marker sÄ±nÄ±fÄ±mÄ±zÄ± Leaflet'in DivIcon'undan tÃ¼retiyoruz.
// Bu, CSS transition'larÄ± yerine Leaflet'in kendi konumlandÄ±rma sistemini kullanmamÄ±zÄ± saÄŸlar,
// bu sayede harita kaydÄ±rma ve zoom iÅŸlemleri sÄ±rasÄ±nda marker'lar daha stabil kalÄ±r.

class DirectTransformMarker extends L.Marker {
    // Marker oluÅŸturulurken Leaflet'in kullandÄ±ÄŸÄ± DOM elementi
    get _old_element() {
        return this._icon;
    }

    // Leaflet'in pozisyonunu gÃ¼ncelleme metodu
    _setPos(pos) {
        L.DomUtil.setPosition(this._icon, pos);

        // UÃ§uÅŸ marker'Ä± iÃ§in rotasyonu da ayarlayalÄ±m
        if (this._icon.querySelector('.plane-rotator') && this.options.heading !== undefined) {
            const rotator = this._icon.querySelector('.plane-rotator');
            // Rotasyonu CSS ile yumuÅŸak geÃ§iÅŸle yap
            rotator.style.transform = `rotate(${this.options.heading}deg)`;
        }
    }
    
    // Marker'Ä±n seÃ§eneklerindeki heading (yÃ¶n) bilgisini gÃ¼nceller
    setHeading(heading) {
        this.options.heading = heading;
        // Konum deÄŸiÅŸikliÄŸini tetikle
        this._setPos(this._leaflet_pos);
    }

    // UÃ§uÅŸ marker'Ä±nÄ±n konumunu yumuÅŸak bir ÅŸekilde yeni pozisyona taÅŸÄ±r.
    // Bu, DirectTransformMarker'Ä±n asÄ±l gÃ¶revini yerine getirir.
    setLatLng(latlng) {
        if (!this._map) return this;

        // Leaflet, marker pozisyonunu "point" olarak hesaplar.
        const newPos = this._map.latLngToLayerPoint(latlng);
        
        // GeÃ§erli pozisyon
        const currentPos = this._leaflet_pos || newPos;

        // CSS transform geÃ§iÅŸini uygulayarak yumuÅŸak animasyon saÄŸla
        // Bu marker'Ä±n DOM elementi (this._icon) Ã¼zerinde Ã§alÄ±ÅŸÄ±r.
        const icon = this._icon;
        if (icon) {
            // Animasyonu baÅŸlatmadan Ã¶nce, eÄŸer zaten bir geÃ§iÅŸ varsa sÄ±fÄ±rla
            icon.style.transition = 'none';
            // Åu anki konumunu hemen ayarla
            L.DomUtil.setPosition(icon, currentPos);

            // KÄ±sa bir sÃ¼re sonra geÃ§iÅŸi etkinleÅŸtir ve yeni konuma ayarla
            setTimeout(() => {
                // 4 saniyelik transition sÃ¼resi
                icon.style.transition = 'transform 4s cubic-bezier(0.4, 0, 0.2, 1)'; 
                L.DomUtil.setPosition(icon, newPos);
            }, 50); 
        }

        this._leaflet_pos = newPos;
        this._latlng = L.latLng(latlng);

        return this;
    }
}


function addFlightToMap(flight, lat, lng, heading) {
    // 1. Terminal NoktalarÄ± (KalkÄ±ÅŸ/VarÄ±ÅŸ)
    const startIcon = L.divIcon({
        className: 'custom-dot-marker',
        html: '<div class="dot-icon dot-green"></div>',
        iconSize: [10, 10],
    });
    const endIcon = L.divIcon({
        className: 'custom-dot-marker',
        html: '<div class="dot-icon dot-red"></div>',
        iconSize: [10, 10],
    });

    const startMarker = L.marker(flight.startCoords, { icon: startIcon }).addTo(map);
    const endMarker = L.marker(flight.endCoords, { icon: endIcon }).addTo(map);

    // 2. Rota Ã‡izgisi
    const polyline = L.polyline([flight.startCoords, flight.endCoords], {
        color: 'yellow',
        weight: 2,
        opacity: 0.6,
        dashArray: '5, 5', // Kesikli Ã§izgi
    }).addTo(map);

    // 3. UÃ§ak Marker'Ä± (DirectTransformMarker kullanÄ±ldÄ±)
    const planeHtml = `
        <div class="plane-rotator" style="transform: rotate(${heading}deg);">
            <i class="plane-icon fa-solid fa-plane"></i>
        </div>
    `;
    const planeIcon = L.divIcon({
        className: 'leaflet-marker-icon flight-marker-animated', // Temel sÄ±nÄ±flar
        html: planeHtml,
        iconSize: [24, 24],
        iconAnchor: [12, 12], // Ortadan tut
    });

    const planeMarker = new DirectTransformMarker([lat, lng], { 
        icon: planeIcon, 
        heading: heading,
        title: flight.id 
    }).addTo(map);
    
    // TÄ±klama olayÄ±nÄ± baÄŸla
    planeMarker.on('click', () => showFlightDetails(flight.id));

    activeFlights[flight.id] = {
        planeMarker,
        startMarker,
        endMarker,
        polyline,
        flightData: flight
    };
}


function updateFlightMarkerPosition(id, lat, lng, heading) {
    const flightMarker = activeFlights[id].planeMarker;
    
    // Konumu gÃ¼ncelle (DirectTransformMarker'Ä±n yumuÅŸak geÃ§iÅŸi burada devreye girer)
    flightMarker.setLatLng([lat, lng]); 

    // YÃ¶nÃ¼ gÃ¼ncelle
    flightMarker.setHeading(heading);
}

function removeFlightFromMap(id) {
    if (activeFlights[id]) {
        map.removeLayer(activeFlights[id].planeMarker);
        map.removeLayer(activeFlights[id].startMarker);
        map.removeLayer(activeFlights[id].endMarker);
        map.removeLayer(activeFlights[id].polyline);
        delete activeFlights[id];
    }
}

// --- DETAY VE LÄ°STE YÃ–NETÄ°MÄ° ---

function showFlightDetails(id) {
    const flight = allFlights[id];
    if (!flight) return;

    // Paneli gÃ¶ster
    toggleRightPanel('detail');

    // Paneli doldur
    DOM.detailId.textContent = flight.id;
    DOM.detailRoute.textContent = `${flight.startCity} > ${flight.endCity}`;
    
    // Durum ve zamanlar (Basit simÃ¼lasyon)
    const position = calculatePositionAtTime(flight, currentMode === 'live' ? currentTime : timeTravelDate.getTime());
    
    let statusText;
    let statusClass;
    if (position.progress >= 1) {
        statusText = 'TAMAMLANDI';
        statusClass = 'text-blue-400';
    } else if (position.progress > 0) {
        statusText = 'AKTÄ°F UÃ‡UÅ';
        statusClass = 'text-green-400';
    } else {
        statusText = 'BEKLEMEDE';
        statusClass = 'text-yellow-400';
    }

    DOM.detailStatus.textContent = statusText;
    DOM.detailStatus.className = `text-sm uppercase font-bold tracking-widest mt-1 ${statusClass}`;
    
    DOM.detailCoords.textContent = `Lat: ${position.lat.toFixed(4)}, Lng: ${position.lng.toFixed(4)}`;
    // DiÄŸer detay alanlarÄ± basitÃ§e doldurulur (ÅŸimdilik statik)
    DOM.detailDepTime.textContent = formatDateTime(flight.parsedStartTime);
    DOM.detailArrTime.textContent = formatDateTime(flight.parsedEndTime);
    
    // Delete butonuna tÄ±klama olayÄ± eklenir
    DOM.deleteBtn.onclick = () => deleteFlight(id);
}


function updateFlightList() {
    DOM.flightList.innerHTML = '';
    const flightIds = Object.keys(allFlights).sort();
    
    if (flightIds.length === 0) {
        DOM.flightList.innerHTML = '<div class="p-4 text-center text-gray-400">HenÃ¼z planlanmÄ±ÅŸ uÃ§uÅŸ rotasÄ± yok.</div>';
        return;
    }

    flightIds.forEach(id => {
        const flight = allFlights[id];
        const listItem = document.createElement('div');
        listItem.id = `list-item-${id}`;
        listItem.className = 'glass-panel p-3 mb-2 rounded-lg cursor-pointer hover:bg-black/60 transition';
        listItem.onclick = () => showFlightDetails(id);

        listItem.innerHTML = `
            <div class="flex justify-between items-center">
                <span class="font-extrabold text-lg text-yellow-400">${flight.id}</span>
                <span class="text-xs text-gray-400">${flight.startCity} - ${flight.endCity}</span>
            </div>
            <div class="list-progress-bar-container">
                <div id="progress-bar-${id}" class="list-progress-bar bg-green-500" style="width: 0%;"></div>
            </div>
        `;
        DOM.flightList.appendChild(listItem);
    });
}

function updateFlightListProgress(id, progress) {
    const progressBar = document.getElementById(`progress-bar-${id}`);
    if (progressBar) {
        const percentage = (progress * 100).toFixed(1);
        progressBar.style.width = `${percentage}%`;
        
        // Renk durumu
        if (progress >= 1) {
            progressBar.classList.remove('bg-green-500', 'bg-yellow-500');
            progressBar.classList.add('bg-blue-500');
        } else if (progress > 0.8) {
            progressBar.classList.remove('bg-green-500', 'bg-blue-500');
            progressBar.classList.add('bg-yellow-500');
        } else {
            progressBar.classList.remove('bg-yellow-500', 'bg-blue-500');
            progressBar.classList.add('bg-green-500');
        }
    }
}

// --- CRUD Ä°ÅLEMLERÄ° (Ã–rnek) ---

function handleFormSubmit(e) {
    e.preventDefault();

    const form = e.target;
    const flightId = form.flightId.value.toUpperCase();
    
    if (allFlights[flightId]) {
        showMessage(`HATA: UÃ§uÅŸ kodu "${flightId}" zaten mevcut.`, 'error');
        return;
    }

    const startCoords = parseCoords(form.startCoords.value);
    const endCoords = parseCoords(form.endCoords.value);
    
    const newFlight = {
        id: flightId,
        startCity: form.startCity.value,
        endCity: form.endCity.value,
        startCoords: startCoords,
        endCoords: endCoords,
        startTime: `${form.startDate.value}T${form.startTime.value}:00`,
        endTime: `${form.endDate.value}T${form.endTime.value}:00`,
    };
    
    newFlight.parsedStartTime = new Date(newFlight.startTime).getTime();
    newFlight.parsedEndTime = new Date(newFlight.endTime).getTime();
    
    allFlights[flightId] = newFlight;
    
    // UI GÃ¼ncelle
    updateFlightList();
    updateFlightPositions(currentMode === 'live' ? currentTime : timeTravelDate.getTime());
    
    showMessage(`BaÅŸarÄ±yla yeni uÃ§uÅŸ rotasÄ± eklendi: ${flightId}`, 'success');
    toggleRightPanel(null); // Formu kapat
    form.reset();
}

function deleteFlight(id) {
    if (confirm(`"${id}" kodlu uÃ§uÅŸu silmek istediÄŸinizden emin misiniz?`)) {
        removeFlightFromMap(id); // Haritadan kaldÄ±r
        delete allFlights[id]; // Veriden sil
        updateFlightList(); // Listeyi gÃ¼ncelle
        toggleRightPanel(null); // Detay panelini kapat
        showMessage(`UÃ§uÅŸ ${id} silindi.`, 'info');
    }
}

// --- TARÄ°H VE SAAT FORMATLAMA ---

function formatDateForInput(date) {
    const d = new Date(date);
    let month = '' + (d.getMonth() + 1);
    let day = '' + d.getDate();
    const year = d.getFullYear();

    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;

    return [year, month, day].join('-');
}

function formatTimeForInput(date) {
    const d = new Date(date);
    let hours = '' + d.getHours();
    let minutes = '' + d.getMinutes();

    if (hours.length < 2) hours = '0' + hours;
    if (minutes.length < 2) minutes = '0' + minutes;

    return [hours, minutes].join(':');
}

function formatDateTime(timestamp, short = false) {
    const date = new Date(timestamp);
    const options = short ? { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' } : 
                            { year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
    return date.toLocaleString('tr-TR', options);
}

// --- HARÄ°TA BAÅLATMA ---

function initMap() {
    if (mapInitialized) return;

    map = L.map('map', { 
        worldCopyJump: true,
        center: [39.0, 35.0], // TÃ¼rkiye'nin ortasÄ±
        zoom: 6,
        zoomControl: false // Zoom butonunu kaldÄ±r
    });
    
    // Zoom butonunu saÄŸ alta taÅŸÄ±
    L.control.zoom({
        position: 'bottomright'
    }).addTo(map);

    // Dark Mode Tile Layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    mapInitialized = true;
    
    // Ä°lk uÃ§uÅŸlarÄ± baÅŸlat
    addInitialFlights();
    
    // HaritayÄ± canlÄ± modda baÅŸlat
    setMode('live');
    updateFlightList();
}


// ====================================================================
// ADD INITIAL FLIGHTS (YENÄ° VERSÄ°YON - ZAMAN KAYDIRMASI YOK)
// ====================================================================

function addInitialFlights() {
    const initialFlightsData = [
        // Bu Ã¶rnek uÃ§uÅŸlar, 4 AralÄ±k 2025 tarihinde gerÃ§ekleÅŸecek ÅŸekilde tanÄ±mlanmÄ±ÅŸtÄ±r.
        { id: 'TK-101', startCity: 'Ankara', endCity: 'Ä°stanbul', startCoords: { lat: 39.9208, lng: 32.8541 }, endCoords: { lat: 41.0082, lng: 28.9784 }, startTime: '2025-12-04T16:00:00', endTime: '2025-12-04T17:30:00' },
        { id: 'PEG-50', startCity: 'Ä°zmir', endCity: 'Antalya', startCoords: { lat: 38.4192, lng: 27.1287 }, endCoords: { lat: 36.8969, lng: 30.7132 }, startTime: '2025-12-04T16:30:00', endTime: '2025-12-04T18:00:00' },
        { id: 'QTR-99', startCity: 'Paris', endCity: 'Doha', startCoords: { lat: 48.8566, lng: 2.3522 }, endCoords: { lat: 25.2769, lng: 51.5200 }, startTime: '2025-12-04T15:00:00', endTime: '2025-12-04T21:00:00' },
    ];
    
    // NOT: Zaman kaydÄ±rma mantÄ±ÄŸÄ± (timeDifference) tamamen kaldÄ±rÄ±lmÄ±ÅŸtÄ±r.
    // UÃ§uÅŸlar artÄ±k tanÄ±mlandÄ±klarÄ± tam tarihte ve saatte baÅŸlar/biter.

    initialFlightsData.forEach(flight => {
        const parsedStartTime = new Date(flight.startTime).getTime();
        const parsedEndTime = new Date(flight.endTime).getTime();
        
        allFlights[flight.id] = {
            ...flight,
            parsedStartTime,
            parsedEndTime
        };
    });
}
// --- DOM ELEMENTLERÄ°NÄ°N TANIMLANMASI VE EVENT BAÄLAMA ---

function assignDOMElements() {
    DOM.messageBox = document.getElementById('message-box');
    DOM.leftPanel = document.getElementById('left-panel');
    DOM.openLeftPanelBtn = document.getElementById('open-left-panel-btn');
    DOM.flightList = document.getElementById('flight-list');
    DOM.rightPanelForm = document.getElementById('right-panel-form');
    DOM.rightPanelDetail = document.getElementById('right-panel-detail');
    DOM.flightForm = document.getElementById('flight-form');
    
    // Detay Paneli
    DOM.detailId = document.getElementById('detail-id');
    DOM.detailStatus = document.getElementById('detail-status');
    DOM.detailRoute = document.getElementById('detail-route');
    DOM.detailCoords = document.getElementById('detail-coords');
    DOM.detailDepTime = document.getElementById('detail-dep-time');
    DOM.detailArrTime = document.getElementById('detail-arr-time');
    DOM.deleteBtn = document.getElementById('delete-btn');
    
    // Zaman Paneli
    DOM.toggleTimeTravelBtn = document.getElementById('toggle-time-travel-btn');
    DOM.timeTravelPanel = document.getElementById('time-travel-panel');
    DOM.closeTimeTravelPanelBtn = document.getElementById('close-time-travel-panel-btn');
    DOM.modeLiveBtn = document.getElementById('mode-live-btn');
    DOM.modeTimeTravelBtn = document.getElementById('mode-time-travel-btn');
    DOM.currentModeDisplay = document.getElementById('current-mode-display');
    DOM.liveControls = document.getElementById('live-controls');
    DOM.timetravelControls = document.getElementById('timetravel-controls');
    DOM.liveSpeedSlider = document.getElementById('live-speed-slider');
    DOM.sliderSpeedDisplay = document.getElementById('slider-speed-display');
    DOM.ttDateInput = document.getElementById('tt-date');
    DOM.ttTimeInput = document.getElementById('tt-time');
    DOM.ttTimeSlider = document.getElementById('tt-time-slider');
    DOM.ttSliderStart = document.getElementById('tt-slider-start');
    DOM.ttSliderEnd = document.getElementById('tt-slider-end');
    DOM.ttSliderDisplay = document.getElementById('tt-slider-display');
    DOM.ttApplyBtn = document.getElementById('apply-timetravel-btn');
}


function setupEventListeners() {
    // Form GÃ¶nderme
    if (DOM.flightForm) DOM.flightForm.addEventListener('submit', handleFormSubmit);

    // Zaman Paneli AÃ§ma/Kapama
    if (DOM.toggleTimeTravelBtn) DOM.toggleTimeTravelBtn.addEventListener('click', () => toggleTimeTravelPanel(true));
    if (DOM.closeTimeTravelPanelBtn) DOM.closeTimeTravelPanelBtn.addEventListener('click', () => toggleTimeTravelPanel(false));

    // Mod DeÄŸiÅŸtirme ButonlarÄ± (HTML'de onclick ile tanÄ±mlandÄ±ÄŸÄ± iÃ§in burada gerek yok, ancak gÃ¼venlik iÃ§in tekrar ekleyelim)
    if (DOM.modeLiveBtn) DOM.modeLiveBtn.addEventListener('click', () => setMode('live'));
    if (DOM.modeTimeTravelBtn) DOM.modeTimeTravelBtn.addEventListener('click', () => setMode('timetravel'));

    // CanlÄ± AkÄ±ÅŸ HÄ±z KaydÄ±rÄ±cÄ±sÄ±
    if (DOM.liveSpeedSlider) DOM.liveSpeedSlider.addEventListener('input', (e) => updateLiveInterval(e.target.value));

    // Zaman YolculuÄŸu KaydÄ±rÄ±cÄ±sÄ±
    if (DOM.ttTimeSlider) {
        // KaydÄ±rma sÄ±rasÄ±nda ekranÄ± gÃ¼ncelle
        DOM.ttTimeSlider.addEventListener('input', (e) => updateTimeTravelDisplay(e.target.value));
        // KaydÄ±rma bittiÄŸinde zamanÄ± uygula
        DOM.ttTimeSlider.addEventListener('mouseup', (e) => applyTimeTravel(e.target.value)); 
        DOM.ttTimeSlider.addEventListener('touchend', (e) => applyTimeTravel(e.target.value)); 
    }
    
    // Zaman YolculuÄŸu Manuel GiriÅŸleri
    if (DOM.ttDateInput) DOM.ttDateInput.addEventListener('change', () => applyTimeTravel());
    if (DOM.ttTimeInput) DOM.ttTimeInput.addEventListener('change', () => applyTimeTravel());
    
    // Uygula Butonu
    if (DOM.ttApplyBtn) DOM.ttApplyBtn.addEventListener('click', () => applyTimeTravel());

}


// Sayfa yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak ana fonksiyon
document.addEventListener('DOMContentLoaded', () => {
    assignDOMElements();
    setupEventListeners();
    initMap();
    // SaÄŸ panel detaylarÄ±nÄ± varsayÄ±lan olarak gizle
    toggleRightPanel(null); 
});
    </script>
</body>
</html>
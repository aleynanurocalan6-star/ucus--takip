<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <title>UÃ§uÅŸ Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* HaritanÄ±n Tam Ekran OlmasÄ±nÄ± SaÄŸlayÄ±n */
        #map { height: 100vh; width: 100vw; }
 
.hide-scrollbar::-webkit-scrollbar {
    display: none;
}
.hide-scrollbar {
    -ms-overflow-style: none; /* IE and Edge */
    scrollbar-width: none; /* Firefox */
}

/* 1.1 Genel Marker KapsayÄ±cÄ±sÄ± */
.leaflet-marker-icon {
    will-change: transform; 
    background-color: transparent !important; 
    border: none !important; 
     z-index: 600 !important;
}

/* 1.2 UÃ§ak Marker'Ä±na Ã–zel GeÃ§iÅŸ SÄ±nÄ±fÄ± (YumuÅŸak Ä°lerleme) */
.flight-marker-animated {
    transition: transform 4s cubic-bezier(0, 0, 0.25, 1) !important; 
}

/* 1.3 UÃ§ak Rotasyon KapsayÄ±cÄ±sÄ± (YÃ¶n DeÄŸiÅŸimi) */
.plane-rotator {
    transition: transform 0.5s ease-out; /* Rotasyonun yumuÅŸak olmasÄ± iÃ§in */
    transform-origin: center center; 
    background-color: transparent !important; 
}

/* 1.4 Terminal NoktalarÄ± KapsayÄ±cÄ±sÄ± */
.custom-dot-marker {
    background-color: transparent !important;
    border: none !important;
}

/* UÃ§ak Simgesi Stili (Font Awesome) */
.plane-icon {
    text-align: center;
    font-size: 24px; 
    line-height: 24px;
    transform-origin: center center;
    
    /* ğŸš€ KRÄ°TÄ°K DÃœZELTME: Ä°konun Kuzeye bakmasÄ± iÃ§in varsayÄ±lanÄ± dÃ¶ndÃ¼r */
    transform: rotate(90deg); 
    
    /* SarÄ± Parlak Efekt */
    color: #fcd34d; /* yellow-400 */
    text-shadow: 0 0 15px rgba(252, 211, 77, 1), 0 0 8px rgba(255, 255, 255, 0.7); 
    animation: pulse-glow 2s infinite alternate ease-in-out; 
    cursor: pointer;
}

/* UÃ§ak Simgesi Parlama Animasyonu */
@keyframes pulse-glow {
    from {
        opacity: 0.9;
        transform: scale(1) rotate(90deg); /* Animasyonda da 90 derece rotasyonu koru */
    }
    to {
        opacity: 1;
        transform: scale(1.2) rotate(90deg); /* Animasyonda da 90 derece rotasyonu koru */
    }
}

/* KalkÄ±ÅŸ/VarÄ±ÅŸ NoktasÄ± DotlarÄ± */
.dot-icon {
    width: 10px !important;
    height: 10px !important;
    border-radius: 50%;
    opacity: 0.8;
    margin-left: -5px !important; 
    margin-top: -5px !important; 
    box-shadow: 0 0 5px rgba(255, 255, 255, 0.5); 
}
.dot-green { background-color: #10b981; }
.dot-red { background-color: #ef4444; }


/* ========================================================== */
/* BÃ–LÃœM 2: Uygulama ArayÃ¼z Stilleri (Glass Panel, Form, vb.) */
/* ========================================================== */

.glass-panel {
    background-color: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
}

.custom-label {
    display: block;
    margin-bottom: 4px;
    font-size: 0.75rem; 
    font-weight: bold;
    color: #ccc;
    letter-spacing: 0.05em; 
}

.custom-input {
    width: 100%;
    padding: 8px 12px;
    border-radius: 6px;
    background-color: #1f2937; 
    border: 1px solid #4b5563; 
    color: #f3f4f6; 
    transition: border-color 0.2s;
}
.custom-input:focus {
    border-color: #fcd34d; 
    outline: none;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px dashed #374151; 
}
.detail-label {
    font-size: 0.875rem; 
    font-weight: 500;
    color: #9ca3af; 
}
.detail-value {
    font-size: 1rem; 
    font-weight: bold;
    color: #e5e7eb; 
}

.custom-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: #FCD34D; 
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
}
.custom-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #FCD34D;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
}
.list-progress-bar-container {
    width: 100%;
    background-color: #374151; 
    border-radius: 9999px;
    height: 6px;
    overflow: hidden;
    margin-top: 5px;
}
.list-progress-bar {
    height: 100%;
    transition: width 0.5s ease-out;
}
.mode-btn {
    padding: 8px 16px;
    border-radius: 9999px;
    font-weight: bold;
    transition: all 0.3s ease;
    cursor: pointer;
}
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">
    
    <div id="map"></div>
    
    <div id="message-box" class="fixed top-5 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-xl text-white z-[600] hidden transition-opacity duration-500 opacity-0" role="alert"></div>

    <div id="left-panel" class="glass-panel absolute top-5 left-0 w-72 max-h-[90vh] rounded-xl z-[500] flex flex-col transition-all duration-300 transform translate-x-[-100%]">
        <div class="p-4 border-b border-yellow-800/50 flex justify-between items-center bg-black/40 rounded-t-xl">
            <span class="text-yellow-400 font-extrabold tracking-widest text-xl">UÃ‡UÅ LÄ°STESÄ°</span>
            <button class="text-gray-400 hover:text-white transition text-xl" onclick="toggleLeftPanel(false)">âœ•</button>
        </div>

        <div id="flight-list" class="p-2 overflow-y-auto flex-grow" style="max-height: calc(90vh - 70px);"> 
            <div class="p-4 text-center text-gray-400">Veriler bekleniyor...</div>
        </div>
    </div>

    <button id="open-left-panel-btn" class="glass-panel absolute top-5 left-5 w-12 h-12 rounded-xl z-[400] text-yellow-400 text-2xl hover:bg-yellow-950 transition flex items-center justify-center" onclick="toggleLeftPanel(true)">
        â˜°
    </button>
    
    <button id="create-route-btn-top" class="absolute top-8 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black font-extrabold px-6 py-2 rounded-full shadow-[0_0_20px_rgba(255,215,0,0.6)] z-[500] hover:scale-105 transition duration-300" onclick="toggleRightPanel('form')">
        âœ¨ YENÄ° ROTA PLANLA
    </button>


    <div id="right-panel-form" class="glass-panel absolute top-5 right-5 bottom-5 w-96 rounded-xl z-[500] p-6 transform translate-x-[150%] transition-transform duration-300 overflow-y-auto hide-scrollbar">
        
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 class="text-3xl text-yellow-400 font-extrabold">ROTA PLANLAMA</h2>
                <p class="text-gray-400 text-sm mt-1">UÃ§uÅŸ bilgilerini girerek haritaya yeni bir rota ekle.</p>
            </div>
            <button class="text-yellow-400 text-xl hover:text-white transition close-btn" onclick="toggleRightPanel(null)">âœ•</button>
        </div>

        <form id="flight-form" class="space-y-6"> 
            
            <div>
                <label class="custom-label" for="flightId">UÃ‡UÅ KODU (ID)</label>
                <input type="text" id="flightId" required value="TK-101" class="custom-input">
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="custom-label" for="startCity">KALKIÅ ÅEHRÄ°</label>
                    <input type="text" id="startCity" required value="Ankara" class="custom-input">
                </div>
                <div>
                    <label class="custom-label" for="endCity">VARIÅ ÅEHRÄ°</label>
                    <input type="text" id="endCity" required value="Ä°stanbul" class="custom-input">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="custom-label" for="startDate">KALKIÅ ZAMANI (TARÄ°H)</label>
                    <input type="date" id="startDate" required value="2025-12-04" class="custom-input">
                </div>
                <div>
                    <label class="custom-label" for="startTime">KALKIÅ SAATÄ°</label>
                    <input type="time" id="startTime" required value="16:00" class="custom-input">
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="custom-label" for="endDate">VARIÅ ZAMANI (TARÄ°H)</label>
                    <input type="date" id="endDate" required value="2025-12-04" class="custom-input">
                </div>
                <div>
                    <label class="custom-label" for="endTime">VARIÅ SAATÄ°</label>
                    <input type="time" id="endTime" required value="18:00" class="custom-input">
                </div>
            </div>

            <div>
                <label class="custom-label" for="startCoords">KALKIÅ KOORDÄ°NATLARI (Lat, Lng)</label>
                <input type="text" id="startCoords" required value="39.9208, 32.8541" class="custom-input">
            </div>

            <div>
                <label class="custom-label" for="endCoords">VARIÅ KOORDÄ°NATLARI (Lat, Lng)</label>
                <input type="text" id="endCoords" required value="41.0082, 28.9784" class="custom-input">
            </div>
            
            <button type="submit" id="submit-btn" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-extrabold py-3 rounded mt-6 transition shadow-[0_0_20px_rgba(255,215,0,0.7)]">
                KAYDET VE BAÅLAT
            </button>
        </form>
    </div>

    <div id="right-panel-detail" class="glass-panel absolute top-5 right-5 w-80 rounded-xl z-[500] transform translate-x-[150%] transition-transform duration-300">
        <div class="p-4 border-b border-yellow-800/50 flex justify-between items-center bg-black/40 rounded-t-xl">
            <div>
                <h2 id="detail-id" class="text-4xl text-yellow-300 font-extrabold tracking-widest">TK-800</h2>
                <span id="detail-status" class="text-sm uppercase font-bold tracking-widest mt-1 text-green-400">AKTÄ°F UÃ‡UÅ</span>
            </div>
            <button class="text-gray-400 hover:text-white transition text-xl" onclick="toggleRightPanel(null)">âœ•</button>
        </div>

        <div class="p-5 space-y-2">
            
            <div class="detail-row">
                <span class="detail-label">Rota:</span>
                <span id="detail-route" class="detail-value text-yellow-100">Bilinmiyor > Bilinmiyor</span> 
            </div>

            <div class="detail-row">
                <span class="detail-label">Konum:</span>
                <span id="detail-coords" class="detail-value font-mono text-base">Lat: 51.1700, Lng: -48.9343</span> 
            </div>

            <div class="detail-row">
                <span class="detail-label">HÄ±z (GS):</span>
                <span class="detail-value">850 km/sa</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">YÃ¼kseklik:</span>
                <span class="detail-value">35.000 ft</span>
            </div>

            <div class="detail-row">
                <span class="detail-label">Rotadan Sapma:</span>
                <span class="detail-value">0.00 km</span>
            </div>
            
            <div class="detail-row">
                <span class="detail-label">KalkÄ±ÅŸ:</span>
                <span id="detail-dep-time" class="detail-value text-sm">05.01.2024 13:00:00</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Tahmini VarÄ±ÅŸ:</span>
                <span id="detail-arr-time" class="detail-value text-sm">N/A</span>
            </div>

            <div class="mt-6">
                <label class="custom-label text-yellow-500 mb-2">Ä°rtifa Verileri (SimÃ¼le)</label>
                <div class="w-full h-16 bg-gradient-to-t from-gray-800 to-transparent rounded border border-gray-700 relative overflow-hidden">
                    <svg class="absolute bottom-0 left-0 w-full h-full" preserveAspectRatio="none" viewBox="0 0 100 100">
                            <path d="M0,80 C20,70 50,40 100,50 L100,100 L0,100 Z" fill="rgba(16, 185, 129, 0.1)" stroke="#10b981" stroke-width="2"/>
                    </svg>
                    <div class="absolute bottom-1 left-2 text-[10px] text-gray-500">KalkÄ±ÅŸ</div>
                    <div class="absolute bottom-1 right-2 text-[10px] text-gray-500">VarÄ±ÅŸ</div>
                </div>
            </div>

            <button id="delete-btn" class="w-full mt-6 bg-red-700 hover:bg-red-600 text-white font-extrabold py-3 rounded text-base transition border border-red-500 shadow-[0_0_15px_rgba(255,0,0,0.5)]">
                UÃ‡UÅU SÄ°L (KayÄ±tlardan KaldÄ±r)
            </button>
        </div>
    </div>
    
    <button id="toggle-time-travel-btn" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-black font-extrabold px-6 py-2 rounded-full shadow-[0_0_20px_rgba(255,215,0,0.6)] z-[500] hover:scale-105 transition duration-300">
        ğŸ•“ CANLI / ZAMAN YOLCULUÄU
    </button>

    <div id="time-travel-panel" class="glass-panel absolute bottom-[80px] left-1/2 transform -translate-x-1/2 w-[90%] md:w-[600px] rounded-xl z-[500] p-4 hidden">
        
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-extrabold text-yellow-400">ZAMAN KONTROL PANELÄ°</h3>
            <button class="text-gray-400 hover:text-white transition text-xl" id="close-time-travel-panel-btn">âœ•</button> 
        </div>

        <div class="flex justify-center space-x-4 mb-4">
            <button id="mode-live-btn" class="mode-btn bg-green-600 hover:bg-green-500 text-white shadow-lg" onclick="setMode('live')">
                ğŸŸ¢ CANLI AKIÅ (Åimdi)
            </button>
            <button id="mode-time-travel-btn" class="mode-btn bg-gray-700 hover:bg-gray-600 text-white shadow-lg" onclick="setMode('timetravel')">
                â³ GERÄ° OYNAT
            </button>
        </div>

        <div class="text-center mb-4 p-2 rounded bg-black/30">
            <span id="current-mode-display" class="font-bold text-lg text-green-400">CANLI AKIÅ MODU</span>
        </div>

        <div id="live-controls" class="space-y-3">
             <label class="custom-label text-yellow-500">CANLI AKIÅ HIZI KONTROLÃœ</label>
             <input type="range" id="live-speed-slider" min="1000" max="10000" value="5000" step="1000" 
                    class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer custom-slider">
             <div class="flex justify-between text-xs text-gray-400">
                 <span>Ã‡ok HÄ±zlÄ± (1 sn)</span>
                 <span id="slider-speed-display" class="font-bold text-yellow-400">5 saniyede bir</span>
                 <span>YavaÅŸ (10 sn)</span>
             </div>
        </div>

        <div id="timetravel-controls" class="space-y-4 hidden mt-6 pt-4 border-t border-gray-700">
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="custom-label" for="tt-date">TARÄ°H SEÃ‡Ä°N</label>
                    <input type="date" id="tt-date" class="custom-input">
                </div>
                <div>
                    <label class="custom-label" for="tt-time">SAAT SEÃ‡Ä°N</label>
                    <input type="time" id="tt-time" class="custom-input">
                </div>
            </div>
            
            <div class="space-y-3">
                <label class="custom-label text-blue-400">TARÄ°HÄ° KAYDIRARAK SEÃ‡Ä°N</label>
                <input type="range" id="tt-time-slider" min="0" max="100" value="50" step="1" 
                            class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer custom-slider">
                <div class="flex justify-between text-xs text-gray-400">
                   <span id="tt-slider-start">Ä°lk KayÄ±t</span>
                   <span id="tt-slider-display" class="font-bold text-blue-400">SeÃ§ili Zaman: N/A</span>
                   <span id="tt-slider-end">Åimdi</span>
                </div>
            </div>

            
            <button id="tt-apply-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-extrabold py-3 rounded transition shadow-[0_0_20px_rgba(0,191,255,0.7)]" onclick="applyTimeTravel()">
                UYGULA VE KONUMU GÃ–STER
            </button>

            <p class="text-yellow-400 text-sm italic text-center pt-2">SeÃ§ilen tarihteki anlÄ±k konumlar haritada gÃ¶sterilecektir.</p>
        </div>

   </div>


<script>
// ====================================================================
// A. SABÄ°TLER VE GLOBAL DEÄÄ°ÅKENLER
// ====================================================================

// API UÃ§ NoktalarÄ±
const API_BASE_URL = 'http://localhost:5058/api/flights';
const GET_ALL_FLIGHT_PLANS_URL = `${API_BASE_URL}/getAllFlightPlans`;
const GET_CURRENT_URL = `${API_BASE_URL}/getCurrent`;
const GET_AT_TIME_URL = `${API_BASE_URL}/getAtTime`;
const ADD_FLIGHT_PLAN_URL = `${API_BASE_URL}/addFlightPlan`;
const SET_FLIGHT_POSITIONS_URL = `${API_BASE_URL}/setFlightPositions`;

// Global deÄŸiÅŸkenler
let map;
let activeFlights = {}; // Haritada gÃ¶sterilen marker'lar
let currentMode = 'live';
let liveInterval;


// ====================================================================
// B. DOM ELEMENTLERÄ°NÄ° ATA
// ====================================================================
function assignDOMElements() {
    DOM.messageBox = document.getElementById('message-box');
    DOM.leftPanel = document.getElementById('left-panel');
    DOM.openLeftPanelBtn = document.getElementById('open-left-panel-btn');
    DOM.flightList = document.getElementById('flight-list');
    DOM.rightPanelForm = document.getElementById('right-panel-form');
    DOM.rightPanelDetail = document.getElementById('right-panel-detail');
    DOM.flightForm = document.getElementById('flight-form');
    
    DOM.detailId = document.getElementById('detail-id');
    DOM.detailStatus = document.getElementById('detail-status');
    DOM.detailRoute = document.getElementById('detail-route');
    DOM.detailCoords = document.getElementById('detail-coords');
    DOM.detailDepTime = document.getElementById('detail-dep-time');
    DOM.detailArrTime = document.getElementById('detail-arr-time');
    DOM.deleteBtn = document.getElementById('delete-btn');

    DOM.toggleTimeTravelBtn = document.getElementById('toggle-time-travel-btn');
    DOM.timeTravelPanel = document.getElementById('time-travel-panel');
    DOM.closeTimeTravelPanelBtn = document.getElementById('close-time-travel-panel-btn');
    DOM.modeLiveBtn = document.getElementById('mode-live-btn');
    DOM.modeTimeTravelBtn = document.getElementById('mode-time-travel-btn');
    DOM.currentModeDisplay = document.getElementById('current-mode-display');
    DOM.liveControls = document.getElementById('live-controls');
    DOM.timetravelControls = document.getElementById('timetravel-controls');
    DOM.liveSpeedSlider = document.getElementById('live-speed-slider');
    DOM.sliderSpeedDisplay = document.getElementById('slider-speed-display');
    DOM.ttDateInput = document.getElementById('tt-date');
    DOM.ttTimeInput = document.getElementById('tt-time');
    DOM.ttTimeSlider = document.getElementById('tt-time-slider');
    DOM.ttSliderStart = document.getElementById('tt-slider-start');
    DOM.ttSliderEnd = document.getElementById('tt-slider-end');
    DOM.ttSliderDisplay = document.getElementById('tt-slider-display');
    DOM.ttApplyBtn = document.getElementById('apply-timetravel-btn');
}

// ====================================================================
// C. EVENT LISTENERLAR
// ====================================================================
function setupEventListeners() {
    if (DOM.flightForm) DOM.flightForm.addEventListener('submit', handleFormSubmit);

    if (DOM.toggleTimeTravelBtn) DOM.toggleTimeTravelBtn.addEventListener('click', () => toggleTimeTravelPanel(true));
    if (DOM.closeTimeTravelPanelBtn) DOM.closeTimeTravelPanelBtn.addEventListener('click', () => toggleTimeTravelPanel(false));

    if (DOM.modeLiveBtn) DOM.modeLiveBtn.addEventListener('click', () => setMode('live'));
    if (DOM.modeTimeTravelBtn) DOM.modeTimeTravelBtn.addEventListener('click', () => setMode('timetravel'));

    if (DOM.liveSpeedSlider) DOM.liveSpeedSlider.addEventListener('input', (e) => updateLiveInterval(e.target.value));

    if (DOM.ttTimeSlider) {
        DOM.ttTimeSlider.addEventListener('input', (e) => updateTimeTravelDisplay(e.target.value));
        DOM.ttTimeSlider.addEventListener('mouseup', (e) => applyTimeTravel(e.target.value));
        DOM.ttTimeSlider.addEventListener('touchend', (e) => applyTimeTravel(e.target.value));
    }

    if (DOM.ttDateInput) DOM.ttDateInput.addEventListener('change', () => applyTimeTravel());
    if (DOM.ttTimeInput) DOM.ttTimeInput.addEventListener('change', () => applyTimeTravel());
    if (DOM.ttApplyBtn) DOM.ttApplyBtn.addEventListener('click', () => applyTimeTravel());
}

// ====================================================================
// D. HARÄ°TA Ä°NÄ°TÄ°ALÄ°ZASYONU
// ====================================================================
function initMap() {
    map = L.map('map').setView([39.925, 32.866], 6); // TÃ¼rkiye koordinatlarÄ±

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
}

// ====================================================================
// E. API FONKSÄ°YONLARI
// ====================================================================
async function getAllFlightPlans() {
    try {
        const res = await fetch(GET_ALL_FLIGHT_PLANS_URL);
        if (!res.ok) throw new Error('UÃ§uÅŸ planlarÄ± alÄ±namadÄ±');
        return await res.json();
    } catch (err) { showMessage(err.message, 'error'); return []; }
}

async function getCurrentFlightPositions() {
    try {
        const res = await fetch(GET_CURRENT_URL);
        if (!res.ok) throw new Error('CanlÄ± uÃ§uÅŸ verileri alÄ±namadÄ±');
        return await res.json();
    } catch (err) { showMessage(err.message, 'error'); return []; }
}

async function getFlightPositionsAtTime(timestamp) {
    try {
        const res = await fetch(`${GET_AT_TIME_URL}?time=${encodeURIComponent(timestamp)}`);
        if (!res.ok) throw new Error('ZamanlÄ± uÃ§uÅŸ verileri alÄ±namadÄ±');
        return await res.json();
    } catch (err) { showMessage(err.message, 'error'); return []; }
}

async function addFlightPlan(flight) {
    try {
        const res = await fetch(ADD_FLIGHT_PLAN_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(flight)
        });
        if (!res.ok) throw new Error('UÃ§uÅŸ planÄ± eklenemedi');
        return await res.json();
    } catch (err) { showMessage(err.message, 'error'); return null; }
}

// ====================================================================
// F. HARÄ°TAYA UÃ‡UÅ EKLEME
// ====================================================================
function renderFlightOnMap(flight) {
    const { FlightId, FlightCode, StartLat, StartLng, EndLat, EndLng } = flight;
    const startCoords = { lat: StartLat, lng: StartLng };
    const endCoords = { lat: EndLat, lng: EndLng };

    const startMarker = L.marker(startCoords, { icon: L.divIcon({ className:'custom-dot-marker', html:'<div class="dot-icon dot-green"></div>', iconSize:[10,10] }) }).addTo(map);
    const endMarker = L.marker(endCoords, { icon: L.divIcon({ className:'custom-dot-marker', html:'<div class="dot-icon dot-red"></div>', iconSize:[10,10] }) }).addTo(map);

    const polyline = L.polyline([startCoords, endCoords], { color:'yellow', weight:2, opacity:0.6, dashArray:'5,5' }).addTo(map);

    const planeIcon = L.divIcon({ className:'leaflet-marker-icon flight-marker-animated', html:`<div class="plane-rotator"><i class="plane-icon fa-solid fa-plane"></i></div>`, iconSize:[24,24], iconAnchor:[12,12] });
    const planeMarker = L.marker(startCoords, { icon: planeIcon, title: FlightCode }).addTo(map);

    planeMarker.on('click', () => showFlightDetails(FlightId));

    activeFlights[FlightId] = { planeMarker, startMarker, endMarker, polyline, flightData: flight };
}

async function refreshFlightsOnMap(mode='live', timestamp=null) {
    Object.keys(activeFlights).forEach(id => {
        map.removeLayer(activeFlights[id].planeMarker);
        map.removeLayer(activeFlights[id].startMarker);
        map.removeLayer(activeFlights[id].endMarker);
        map.removeLayer(activeFlights[id].polyline);
    });
    activeFlights = {};

    let flights;
    if (mode==='live') flights = await getCurrentFlightPositions();
    else if (mode==='timetravel' && timestamp) flights = await getFlightPositionsAtTime(timestamp);
    else flights = [];

    flights.forEach(flight => renderFlightOnMap(flight));
    updateFlightListPanel(flights);
}

// ====================================================================
// G. PANEL GÃœNCELLEME
// ====================================================================
function updateFlightListPanel(flights) {
    const container = DOM.flightList;
    container.innerHTML = '';

    if (!flights.length) {
        container.innerHTML = '<div class="p-4 text-center text-gray-400">Haritada aktif uÃ§uÅŸ bulunmamaktadÄ±r.</div>';
        return;
    }

    flights.forEach(flight => {
        const div = document.createElement('div');
        div.className = 'detail-row cursor-pointer';
        div.innerHTML = `<span class="detail-label">${flight.FlightCode}</span>
                         <span class="detail-value">${flight.CurrentLat?.toFixed(2)||flight.StartLat}, ${flight.CurrentLng?.toFixed(2)||flight.StartLng}</span>`;
        div.onclick = () => showFlightDetails(flight.FlightId);
        container.appendChild(div);
    });
}

function showFlightDetails(flightId) {
    const flight = activeFlights[flightId]?.flightData;
    if (!flight) return;
    toggleRightPanel('detail');
    DOM.detailId.textContent = flight.FlightId;
    DOM.detailStatus.textContent = flight.Status || 'PlanlandÄ±';
    DOM.detailRoute.textContent = `${flight.StartLat},${flight.StartLng} â†’ ${flight.EndLat},${flight.EndLng}`;
    DOM.detailCoords.textContent = `${flight.CurrentLat?.toFixed(2)||flight.StartLat},${flight.CurrentLng?.toFixed(2)||flight.StartLng}`;
}

// ====================================================================
// H. MOD VE PANEL FONKSÄ°YONLARI
// ====================================================================
function toggleRightPanel(panelName) {
    DOM.rightPanelForm.classList.add('translate-x-[150%]');
    DOM.rightPanelDetail.classList.add('translate-x-[150%]');
    if(panelName==='form') DOM.rightPanelForm.classList.remove('translate-x-[150%]');
    if(panelName==='detail') DOM.rightPanelDetail.classList.remove('translate-x-[150%]');
}

function toggleTimeTravelPanel(show) {
    if(show) {
        DOM.timeTravelPanel.classList.remove('hidden');
        DOM.toggleTimeTravelBtn.classList.add('hidden');
    } else {
        DOM.timeTravelPanel.classList.add('hidden');
        DOM.toggleTimeTravelBtn.classList.remove('hidden');
    }
}

function setMode(mode) {
    currentMode = mode;
    DOM.modeLiveBtn.classList.toggle('bg-green-600', mode==='live');
    DOM.modeTimeTravelBtn.classList.toggle('bg-yellow-500', mode==='timetravel');
    DOM.liveControls.classList.toggle('hidden', mode!=='live');
    DOM.timetravelControls.classList.toggle('hidden', mode!=='timetravel');

    if(mode==='live') refreshFlightsOnMap('live');
    else if(mode==='timetravel') {
        const timestamp = DOM.ttDateInput.value + 'T' + DOM.ttTimeInput.value + ':00';
        refreshFlightsOnMap('timetravel', timestamp);
    }
}

// ====================================================================
// I. CANLI VE ZAMAN YOLCULUÄU
// ====================================================================
function updateLiveInterval(ms) {
    clearInterval(liveInterval);
    DOM.sliderSpeedDisplay.textContent = `${ms/1000} saniyede bir`;
    liveInterval = setInterval(() => refreshFlightsOnMap('live'), ms);
}

function updateTimeTravelDisplay(sliderValue) {
    // Opsiyonel: Slider gÃ¶sterimi iÃ§in
    DOM.ttSliderDisplay.textContent = `SeÃ§ili Zaman: ${DOM.ttDateInput.value} ${DOM.ttTimeInput.value}`;
}

function applyTimeTravel(sliderValue) {
    const timestamp = DOM.ttDateInput.value + 'T' + DOM.ttTimeInput.value + ':00';
    refreshFlightsOnMap('timetravel', timestamp);
}
function toggleLeftPanel(open) {
    const panel = document.getElementById('left-panel');
    if(open){
        panel.style.transform = 'translateX(0)';
    } else {
        panel.style.transform = 'translateX(-100%)';
    }
}

// ====================================================================
// J. FORM HANDLER
// ====================================================================
const DOM = {
    flightId: document.getElementById('flightId'),
    flightCode: document.getElementById('flightCode'),
    startCoords: document.getElementById('startCoords'),
    endCoords: document.getElementById('endCoords'),
    speed: document.getElementById('speed')
};
async function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target; // form element
    const flight = {
        FlightId: parseInt(form.flightId.value),
        FlightCode: form.flightCode.value,
        StartLat: parseFloat(form.startCoords.value.split(',')[0]),
        StartLng: parseFloat(form.startCoords.value.split(',')[1]),
        EndLat: parseFloat(form.endCoords.value.split(',')[0]),
        EndLng: parseFloat(form.endCoords.value.split(',')[1]),
        Speed: parseFloat(form.speed.value)
    };
    const created = await addFlightPlan(flight);
    if(created){
        showMessage('UÃ§uÅŸ planÄ± oluÅŸturuldu','success');
        renderFlightOnMap(created);
        updateFlightListPanel([created,...Object.values(activeFlights).map(a=>a.flightData)]);
    }
}


// ====================================================================
// K. SAYFA YÃœKLENDÄ°ÄÄ°NDE INIT
// ====================================================================
document.addEventListener('DOMContentLoaded', () => {
    assignDOMElements();
    setupEventListeners();
    initMap();
    toggleRightPanel(null); 
    refreshFlightsOnMap('live');
});
</script>

</body>
</html>